<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hyu.property.mapper.NoticeReadMapper">

    <resultMap type="NoticeRead" id="NoticeRead">
        <result property="id" column="id"/>
        <result property="noticeId" column="notice_id"/>
        <result property="userId" column="user_id"/>
        <result property="readTime" column="read_time"/>
    </resultMap>

    <resultMap type="NoticeReadVO" id="NoticeReadResult">
        <result property="id" column="id"/>
        <result property="noticeId" column="notice_id"/>
        <result property="userId" column="user_id"/>
        <result property="readTime" column="read_time"/>
        <result property="noticeTitle" column="notice_title"/>
        <result property="noticeType" column="notice_type"/>
        <result property="userName" column="user_name"/>
        <result property="userPhone" column="user_phone"/>
        <result property="houseNo" column="house_no"/>
    </resultMap>

    <sql id="selectNoticeReadVo">
        select nr.id, nr.notice_id, nr.user_id, nr.read_time,
               n.notice_title, n.notice_type,
               u.real_name as user_name, u.phone as user_phone,
               h.house_no
        from notice_read nr
        left join notice n on nr.notice_id = n.id
        left join sys_user u on nr.user_id = u.id
        left join user_house uh on nr.user_id = uh.user_id and uh.is_current = 1
        left join house h on uh.house_id = h.id
    </sql>

    <select id="selectNoticeReadList" parameterType="NoticeRead" resultMap="NoticeReadResult">
        <include refid="selectNoticeReadVo"/>
        <where>
            <if test="noticeId != null">
                and nr.notice_id = #{noticeId}
            </if>
            <if test="userId != null">
                and nr.user_id = #{userId}
            </if>
            <if test="params.beginTime != null and params.beginTime != ''">
                and date_format(nr.read_time,'%y%m%d') &gt;= date_format(#{params.beginTime},'%y%m%d')
            </if>
            <if test="params.endTime != null and params.endTime != ''">
                and date_format(nr.read_time,'%y%m%d') &lt;= date_format(#{params.endTime},'%y%m%d')
            </if>
        </where>
        order by nr.read_time desc
    </select>

    <select id="selectNoticeReadsByNoticeId" parameterType="Long" resultMap="NoticeReadResult">
        <include refid="selectNoticeReadVo"/>
        where nr.notice_id = #{noticeId}
        order by nr.read_time desc
    </select>

    <select id="selectNoticeReadsByUserId" parameterType="Long" resultMap="NoticeReadResult">
        <include refid="selectNoticeReadVo"/>
        where nr.user_id = #{userId}
        order by nr.read_time desc
    </select>

    <select id="selectUnreadUsersByNoticeId" parameterType="Long" resultMap="NoticeReadResult">
        select u.id as user_id, u.real_name as user_name, u.phone as user_phone, h.house_no
        from sys_user u
        left join user_house uh on u.id = uh.user_id and uh.is_current = 1
        left join house h on uh.house_id = h.id
        where u.user_type = 3 and u.status = 1
        and u.id not in (
            select nr.user_id from notice_read nr where nr.notice_id = #{noticeId}
        )
        order by u.real_name
    </select>

    <select id="selectUserNoticeRead" resultMap="NoticeRead">
        select id, notice_id, user_id, read_time
        from notice_read
        where notice_id = #{noticeId} and user_id = #{userId}
    </select>

    <select id="countReadUsersByNoticeId" parameterType="Long" resultType="Integer">
        select count(*) from notice_read
        where notice_id = #{noticeId}
    </select>

    <insert id="batchInsertNoticeRead">
        insert into notice_read (notice_id, user_id, read_time)
        values
        <foreach collection="list" item="item" separator=",">
            (#{item.noticeId}, #{item.userId}, #{item.readTime})
        </foreach>
    </insert>

    <delete id="deleteNoticeReadsByNoticeId" parameterType="Long">
        delete from notice_read where notice_id = #{noticeId}
    </delete>

</mapper>